<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Recommender Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #212529;
            /* Darker heading color */
            margin-bottom: 8px;
            font-weight: 700;
        }

        .lead {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 15px;
        }

        .persona-match {
            font-size: 1.25rem;
            font-weight: 600;
            /* Bolder persona match */
            color: #007bff;
            margin-bottom: 25px;
            padding: 10px;
            background-color: #e7f1ff;
            border-left: 5px solid #007bff;
            border-radius: 5px;
        }

        .accordion-item {
            margin-bottom: 15px;
            /* Space between accordion items */
            border-radius: 8px;
            /* Rounded accordion items */
            border: 1px solid #dee2e6;
        }

        .accordion-header {
            border-radius: 8px 8px 0 0;
            /* Match item rounding */
        }

        .accordion-button {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            border-radius: 8px 8px 0 0 !important;
            /* Ensure rounding on top */
        }

        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
            /* Bootstrap focus style */
        }

        .accordion-button:not(.collapsed) {
            color: #0a58ca;
            /* Darker blue when open */
            background-color: #e0eFFF;
            /* Lighter blue background when open */
        }

        .property-title-in-header {
            font-size: 1.2rem;
            /* Slightly smaller for balance */
            font-weight: 600;
            margin-bottom: 12px;
            width: 100%;
            color: #343a40;
        }

        .accordion-button:not(.collapsed) .property-title-in-header {
            color: #0a58ca;
        }

        .carousel {
            width: 100%;
            max-width: 350px;
            /* Slightly smaller carousel */
            margin-bottom: 10px;
            border-radius: 6px;
            /* Softer rounding for carousel */
            overflow: hidden;
            border: 1px solid #ddd;
            /* Subtle border for carousel */
        }

        .carousel-item img {
            height: 180px;
            /* Adjusted height */
            object-fit: cover;
            border-radius: 6px;
            /* Match carousel rounding */
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.3);
            /* Darker icon background */
            border-radius: 50%;
            padding: 10px;
        }

        .accordion-body {
            padding: 1.25rem;
            /* More padding in body */
        }

        .accordion-body ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
            /* Remove default ul margin */
        }

        .accordion-body ul li {
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            /* Lighter border */
            font-size: 0.95rem;
            color: #495057;
        }

        .accordion-body ul li strong {
            color: #212529;
            /* Darker label */
        }

        .accordion-body ul li:last-child {
            border-bottom: none;
        }

        .score-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .score {
            font-weight: bold;
            margin-top: 8px;
            display: block;
            font-size: 1rem;
            color: #198754;
            /* Green for scores */
        }

        .score strong {
            color: #343a40;
        }

        .details-columns {
            display: flex;
            flex-wrap: wrap;
        }

        .details-columns>div {
            flex: 1 1 50%;
            /* Allow shrinking but prefer 50% */
            min-width: 200px;
            /* Prevent too much squishing */
            padding-right: 15px;
            box-sizing: border-box;
        }

        .details-columns>div:last-child {
            padding-right: 0;
        }

        .accordion-button::after {
            margin-left: auto;
            align-self: center;
        }

        .accordion-button-content-wrapper {
            display: flex;
            flex-direction: column;
            width: calc(100% - 30px);
            /* Accommodate accordion icon */
        }

        /* Fallback for images */
        .img-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 180px;
            /* Must match .carousel-item img height */
            background-color: #e9ecef;
            color: #6c757d;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Styling for facilities if it's a list */
        .facilities-list {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 5px;
        }

        .facilities-list li {
            font-size: 0.9rem;
            padding: 2px 0;
            border-bottom: none;
            /* Remove border for facility list items */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="text-start mb-3">
            <a href="/" class="btn btn-sm btn-outline-secondary">&larr; Back to Search</a>
        </div>
        {% if properties and properties[0] and properties[0].best_persona_match %}
        <p class="persona-match">Best Persona Match: {{ properties[0].best_persona_match }}</p>
        {% endif %}
        <h1>Here's the recommendation for {{ prop_type }} in {{ city }}</h1>
        <p class="lead">Based on your preferences, we recommend the following properties:</p>
        {% if properties %}
        <div class="accordion" id="propertyAccordion">
            {% for property in properties %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ loop.index0 }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ loop.index0 }}" aria-expanded="false"
                        aria-controls="collapse-{{ loop.index0 }}">
                        <div class="accordion-button-content-wrapper">
                            <div class="property-title-in-header">{{ property.title | default('N/A') }}</div>
                        </div>
                    </button>
                </h2>

                <!-- Carousel moved outside the button for layout integrity -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        {% if property.image_url and property.image_url is iterable and property.image_url is not string
                        %}
                        <div id="carousel-{{ loop.index0 }}" class="carousel slide" data-bs-ride="carousel"
                            data-bs-interval="3500">
                            <div class="carousel-inner">
                                {% for image_src in property.image_url %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ image_src }}" class="d-block w-100"
                                        alt="Property Image {{ loop.index }}"
                                        onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\'img-fallback\'>Image not available</div>';">
                                </div>
                                {% endfor %}
                            </div>
                            {% if property.image_url|length > 1 %}
                            <button class="carousel-control-prev" type="button"
                                data-bs-target="#carousel-{{ loop.index0 }}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button"
                                data-bs-target="#carousel-{{ loop.index0 }}" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="carousel">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <div class="img-fallback">No images available</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 d-flex flex-column justify-content-center align-items-start">
                        <div class="score mb-2">
                            <strong>Similarity Score:</strong>
                            {{ property.similarity_score | round(5) | default('N/A') }}
                        </div>
                        <div class="score">
                            <strong>Gap Score:</strong>
                            {{ property.gap_score | round(5) | default('N/A') }}
                        </div>
                    </div>
                </div>

                <div id="collapse-{{ loop.index0 }}" class="accordion-collapse collapse"
                    aria-labelledby="heading-{{ loop.index0 }}" data-bs-parent="#propertyAccordion">
                    <div class="accordion-body">
                        <!-- Existing Details Section -->
                        <div class="details-columns">
                            <div>
                                <ul>
                                    <li><strong>Land Area:</strong> {{ property.land_area | default('N/A') }} m²</li>
                                    <li><strong>Building Area:</strong> {{ property.building_area | default('N/A') }} m²
                                    </li>
                                    <li><strong>Bedrooms:</strong> {{ property.bedrooms | default('N/A') }}</li>
                                    <li><strong>Bathrooms:</strong> {{ property.bathrooms | default('N/A') }}</li>
                                </ul>
                            </div>
                            <div>
                                <ul>
                                    <li><strong>Floors:</strong> {{ property.floors | default('N/A') }}</li>
                                    <li><strong>Certificate:</strong> {{ property.certificate | default('N/A') }}</li>
                                    <li>
                                        <strong>Facilities:</strong>
                                        {% if property.facilities %}
                                        {% if property.facilities is iterable and property.facilities is not string %}
                                        <ul class="facilities-list">
                                            {% for facility in property.facilities %}
                                            <li>{{ facility }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% else %}
                                        {{ property.facilities }}
                                        {% endif %}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                            <!-- Description Section (newly added) -->
                            <div class="property-description mb-3">
                                <h5>Reasoning</h5>
                                <p>This is a placeholder for the property description. In the future, this can be
                                    populated
                                    with details like location benefits, recent renovations, or neighborhood highlights.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="lead text-center mt-5">No properties match your criteria. Please try adjusting your search.</p>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.accordion-item').forEach(item => {
                const collapseElement = item.querySelector('.accordion-collapse');
                const carouselElement = item.querySelector('.carousel');

                if (collapseElement && carouselElement) {
                    let carouselInstance = bootstrap.Carousel.getInstance(carouselElement);
                    if (carouselInstance) {
                        collapseElement.addEventListener('hide.bs.collapse', function () {
                            carouselInstance.pause();
                        });
                        collapseElement.addEventListener('show.bs.collapse', function () {
                            carouselInstance.cycle();
                        });
                    } else {
                        // Fallback or error logging if carousel instance isn't found
                        // This might happen if the carousel HTML is malformed or Bootstrap JS hasn't processed it yet.
                        // For dynamically added content, ensure carousels are initialized after insertion.
                        // console.warn('Carousel instance not found for:', carouselElement);
                    }
                }
            });
        });
    </script>
</body>

</html>